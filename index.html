<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÌÜµÏó≠Í∏∞Í∏∞ Í¥ÄÎ¶¨ v3</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header h1 { color: #667eea; font-size: 2rem; }
        .header-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .sync-btn {
            background: #10b981;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            font-size: 15px;
        }
        .sync-btn:hover { background: #059669; }
        .sync-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .inventory-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .inventory-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #0ea5e9;
        }
        .inventory-title { font-size: 16px; font-weight: 700; color: #0c4a6e; margin-bottom: 15px; }
        .device-row {
            display: flex;
            justify-content: space-between;
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .device-count { font-size: 20px; font-weight: 700; color: #0ea5e9; }
        .device-count.low { color: #ef4444; }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(255,255,255,0.3);
            color: white;
            font-size: 14px;
        }
        .tab-btn.active { background: white; color: #667eea; }
        .content { display: none; }
        .content.active { display: block; }
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .card h2 { color: #1f2937; font-size: 1.5rem; margin-bottom: 20px; }
        .week-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .week-nav button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        .week-nav button:hover { background: #5568d3; }
        .all-day-events {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .all-day-event {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #92400e;
            cursor: pointer;
            border-left: 3px solid #f59e0b;
        }
        .all-day-event:hover { background: #fef3c7; }
        .weekly-grid {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 0;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .time-label {
            background: #f9fafb;
            padding: 12px 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }
        .day-header {
            background: #f3f4f6;
            padding: 12px;
            text-align: center;
            font-weight: 700;
            font-size: 13px;
            color: #374151;
            border-right: 1px solid #e5e7eb;
            border-bottom: 2px solid #e5e7eb;
        }
        .day-header.today { background: #dbeafe; color: #1e40af; }
        .time-slot {
            background: white;
            padding: 4px;
            min-height: 70px;
            font-size: 11px;
            position: relative;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }
        .event-block {
            position: absolute;
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border: 2px solid #6366f1;
            border-radius: 6px;
            padding: 6px;
            font-size: 11px;
            font-weight: 600;
            color: #3730a3;
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
            transition: all 0.2s;
            z-index: 10;
        }
        .event-block:hover {
            background: linear-gradient(135deg, #c7d2fe 0%, #a5b4fc 100%);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.5);
            transform: scale(1.02);
            z-index: 20;
        }
        .event-block.Ïô∏Í∑º {
            background: linear-gradient(135deg, #dbeafe 0%, #bae6fd 100%);
            border-color: #0ea5e9;
            color: #0c4a6e;
        }
        .event-block.Ï∂úÏû• {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
            border-color: #ef4444;
            color: #991b1b;
        }
        .event-block.assigned {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10b981;
            color: #065f46;
        }
        .event-block.Ïô∏Í∑º.assigned {
            background: linear-gradient(135deg, #bae6fd 0%, #7dd3fc 100%);
            border-color: #0891b2;
        }
        .event-block.Ï∂úÏû•.assigned {
            background: linear-gradient(135deg, #fca5a5 0%, #f87171 100%);
            border-color: #dc2626;
        }
        .assigned-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #10b981;
            color: white;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 4px;
            font-weight: 700;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.75);
            z-index: 99999;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex !important; }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.4);
        }
        .modal-header {
            font-size: 1.8rem;
            font-weight: 800;
            color: #1f2937;
            margin-bottom: 25px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }
        .modal-info {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            font-size: 15px;
            line-height: 1.8;
        }
        .device-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .device-input-group {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
        }
        .device-input-group label { display: block; font-size: 14px; font-weight: 600; color: #6b7280; margin-bottom: 8px; }
        .device-input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            background: white;
            cursor: pointer;
        }
        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        .modal-btn {
            flex: 1;
            padding: 20px 30px;
            border: none;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }
        .modal-btn.cancel {
            background: #f3f4f6;
            color: #374151;
            border: 3px solid #d1d5db;
        }
        .modal-btn.cancel:hover {
            background: #e5e7eb;
            transform: scale(1.05);
        }
        .modal-btn.confirm {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.5);
        }
        .modal-btn.confirm:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 30px rgba(16, 185, 129, 0.6);
        }
        .loading { text-align: center; padding: 40px; color: #6b7280; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>üéôÔ∏è ÌÜµÏó≠Í∏∞Í∏∞ Í¥ÄÎ¶¨</h1>
                <div class="header-buttons">
                    <button class="sync-btn" onclick="manualRefresh()" id="refreshBtn">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
                    <button class="sync-btn" onclick="syncTeamUp()" id="syncBtn">üìÖ TeamUp ÎèôÍ∏∞Ìôî</button>
                </div>
            </div>
            
            <div class="inventory-grid">
                <div class="inventory-card">
                    <div class="inventory-title">‚ú® Ïã†Ìòï Î™®Îç∏ Ïû¨Í≥†</div>
                    <div class="device-row">
                        <span>ÏÜ°Ïã†Í∏∞</span>
                        <span class="device-count" id="newTxStock">-</span>
                    </div>
                    <div class="device-row">
                        <span>ÏàòÏã†Í∏∞</span>
                        <span class="device-count" id="newRxStock">-</span>
                    </div>
                </div>
                
                <div class="inventory-card">
                    <div class="inventory-title">‚öôÔ∏è Íµ¨Ìòï Î™®Îç∏ Ïû¨Í≥†</div>
                    <div class="device-row">
                        <span>ÏÜ°Ïã†Í∏∞</span>
                        <span class="device-count" id="oldTxStock">-</span>
                    </div>
                    <div class="device-row">
                        <span>ÏàòÏã†Í∏∞</span>
                        <span class="device-count" id="oldRxStock">-</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('teamup')">TeamUp Ï£ºÍ∞Ñ</button>
            <button class="tab-btn" onclick="showTab('list')">Î∞òÏ∂ú Î™©Î°ù</button>
        </div>

        <div id="teamup" class="content active">
            <div class="card" style="padding: 0; overflow: hidden;">
                <div style="padding: 20px; border-bottom: 2px solid #e5e7eb;">
                    <div class="week-nav">
                        <button onclick="changeTeamUpWeek(-1)">‚óÄ Ïù¥Ï†Ñ Ï£º</button>
                        <h2 id="teamupWeekTitle" style="margin: 0;">TeamUp Ï£ºÍ∞Ñ ÏùºÏ†ï</h2>
                        <button onclick="changeTeamUpWeek(1)">Îã§Ïùå Ï£º ‚ñ∂</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <div class="weekly-grid" id="teamupWeeklyGrid"></div>
                </div>
            </div>
        </div>

        <div id="list" class="content">
            <div class="card">
                <h2>Ï†ÑÏ≤¥ Î∞òÏ∂ú Î™©Î°ù</h2>
                <div id="rentalList"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="assignModal">
        <div class="modal-content">
            <div class="modal-header" id="assignModalTitle">Í∏∞Í∏∞ Î∞∞Ï†ï</div>
            <div id="assignModalInfo" class="modal-info"></div>
            
            <h3 style="margin: 25px 0 20px 0; color: #374151; font-size: 1.3rem;">ÏÇ¨Ïö© Í∏∞Í∏∞ ÏÑ†ÌÉù</h3>
            <div class="device-selector">
                <div class="device-input-group">
                    <label>‚ú® Ïã†Ìòï ÏÜ°Ïã†Í∏∞</label>
                    <select id="modalNewTx">
                        <option value="0">0ÎåÄ</option>
                        <option value="1">1ÎåÄ</option>
                        <option value="2">2ÎåÄ</option>
                        <option value="3">3ÎåÄ</option>
                        <option value="4">4ÎåÄ</option>
                    </select>
                </div>
                <div class="device-input-group">
                    <label>‚ú® Ïã†Ìòï ÏàòÏã†Í∏∞</label>
                    <select id="modalNewRx"></select>
                </div>
                <div class="device-input-group">
                    <label>‚öôÔ∏è Íµ¨Ìòï ÏÜ°Ïã†Í∏∞</label>
                    <select id="modalOldTx">
                        <option value="0">0ÎåÄ</option>
                        <option value="1">1ÎåÄ</option>
                        <option value="2">2ÎåÄ</option>
                        <option value="3">3ÎåÄ</option>
                        <option value="4">4ÎåÄ</option>
                        <option value="5">5ÎåÄ</option>
                    </select>
                </div>
                <div class="device-input-group">
                    <label>‚öôÔ∏è Íµ¨Ìòï ÏàòÏã†Í∏∞</label>
                    <select id="modalOldRx"></select>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeAssignModal()">Ï∑®ÏÜå</button>
                <button class="modal-btn confirm" onclick="saveAssignment()">Î∞∞Ï†ïÌïòÍ∏∞</button>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyVFqge7Z3x3kOZp3wNgqXpO8z5sd20EcTlygJMevX5dgbI6dPCxXaboahysbVV6j607w/exec';
        
        let inv = { new_model: { transmitter: 4, receiver: 28 }, old_model: { transmitter: 5, receiver: 31 } };
        let rentals = [];
        let events = [];
        let teamupWeek = new Date();
        let selectedEvent = null;

        // ÎìúÎ°≠Îã§Ïö¥ Ï¥àÍ∏∞Ìôî
        function initDropdowns() {
            const newRx = document.getElementById('modalNewRx');
            const oldRx = document.getElementById('modalOldRx');
            
            for (let i = 0; i <= 28; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = i + 'ÎåÄ';
                newRx.appendChild(opt);
            }
            
            for (let i = 0; i <= 31; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = i + 'ÎåÄ';
                oldRx.appendChild(opt);
            }
        }

        async function init() {
            initDropdowns();
            try {
                const test = await fetch(WEB_APP_URL + '?action=getInventory', { method: 'GET', redirect: 'follow' });
                if (!test.ok) throw new Error('ÏÑúÎ≤Ñ Ïò§Î•ò');
                await loadInventory();
                await loadRentals();
                await loadTeamUpEvents();
                updateAll();
                console.log('‚úÖ ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÑ±Í≥µ');
            } catch (error) {
                console.warn('‚ö†Ô∏è ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞ Î™®Îìú');
                initDummy();
            }
        }

        function initDummy() {
            events = [
                { eventId: '1', title: 'Pangyo | Lunch', startDate: '2026-01-20T12:00:00', endDate: '2026-01-20T13:00:00', interpretType: 'ÌòÑÏû•ÌÜµÏó≠', assignee: 'Îã§ÌòÑ' },
                { eventId: '2', title: '[Ï∂úÏû•] Ï£ºÌôî - LA', startDate: '2026-01-22T08:00:00', endDate: '2026-01-24T18:00:00', interpretType: 'Ï∂úÏû•', assignee: 'Ï£ºÌôî' }
            ];
            updateAll();
        }

        async function loadInventory() {
            try {
                const r = await fetch(WEB_APP_URL + '?action=getInventory', { method: 'GET', redirect: 'follow' });
                const d = await r.json();
                if (d.success) inv = d.inventory;
                updateInvDisplay();
            } catch (e) { console.error('Ïû¨Í≥† Ïò§Î•ò:', e); }
        }

        async function loadRentals() {
            try {
                const r = await fetch(WEB_APP_URL + '?action=getRentals', { method: 'GET', redirect: 'follow' });
                const d = await r.json();
                if (d.success) rentals = d.rentals;
            } catch (e) { console.error('Î∞òÏ∂ú Ïò§Î•ò:', e); }
        }

        async function loadTeamUpEvents() {
            try {
                console.log('TeamUp Î°úÎìú...');
                const r = await fetch(WEB_APP_URL + '?action=getTeamUpEvents', { method: 'GET', redirect: 'follow' });
                const d = await r.json();
                console.log('TeamUp ÏùëÎãµ:', d);
                if (d.success) {
                    events = d.events;
                    console.log('Ïù¥Î≤§Ìä∏ Ïàò:', events.length);
                }
            } catch (e) { console.error('TeamUp Ïò§Î•ò:', e); }
        }

        async function manualRefresh() {
            const btn = document.getElementById('refreshBtn');
            btn.textContent = '‚è≥ Î°úÎî©...';
            btn.disabled = true;
            await loadInventory();
            await loadRentals();
            await loadTeamUpEvents();
            updateAll();
            btn.textContent = 'üîÑ ÏÉàÎ°úÍ≥†Ïπ®';
            btn.disabled = false;
        }

        async function syncTeamUp() {
            const btn = document.getElementById('syncBtn');
            btn.textContent = '‚è≥ ÎèôÍ∏∞Ìôî...';
            btn.disabled = true;
            try {
                console.log('ÎèôÍ∏∞Ìôî ÏãúÏûë...');
                const r = await fetch(WEB_APP_URL + '?action=syncTeamUp', { method: 'GET', redirect: 'follow' });
                const d = await r.json();
                console.log('ÎèôÍ∏∞Ìôî Í≤∞Í≥º:', d);
                if (d.success) {
                    alert(`‚úÖ ÏôÑÎ£å!\n\nÏ†ÑÏ≤¥: ${d.total}Í∞ú\nÏÉàÎ°ú Ï∂îÍ∞Ä: ${d.count}Í∞ú\nÏóÖÎç∞Ïù¥Ìä∏: ${d.updated}Í∞ú`);
                    await loadTeamUpEvents();
                    updateAll();
                } else {
                    alert('‚ùå Ïã§Ìå®: ' + d.error);
                }
            } catch (e) {
                console.error('ÎèôÍ∏∞Ìôî Ïò§Î•ò:', e);
                alert('‚ùå Ïò§Î•ò: ' + e);
            }
            btn.textContent = 'üìÖ TeamUp ÎèôÍ∏∞Ìôî';
            btn.disabled = false;
        }

        function updateInvDisplay() {
            document.getElementById('newTxStock').textContent = inv.new_model.transmitter;
            document.getElementById('newRxStock').textContent = inv.new_model.receiver;
            document.getElementById('oldTxStock').textContent = inv.old_model.transmitter;
            document.getElementById('oldRxStock').textContent = inv.old_model.receiver;
        }

        function showTab(tab) {
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
            if (tab === 'list') updateList();
        }

        function changeTeamUpWeek(d) {
            if (d === 0) teamupWeek = new Date();
            else teamupWeek.setDate(teamupWeek.getDate() + (d * 7));
            updateTeamUpWeekly();
        }

        function updateTeamUpWeekly() {
            const grid = document.getElementById('teamupWeeklyGrid');
            grid.innerHTML = '';
            
            const ws = new Date(teamupWeek);
            ws.setDate(teamupWeek.getDate() - teamupWeek.getDay() + 1);
            const we = new Date(ws);
            we.setDate(ws.getDate() + 6);
            
            document.getElementById('teamupWeekTitle').textContent = 
                `${ws.getMonth()+1}/${ws.getDate()} ~ ${we.getMonth()+1}/${we.getDate()}`;
            
            const weekEvents = events.filter(evt => {
                const s = new Date(evt.startDate);
                return s >= ws && s <= we;
            });
            
            const allDayEvents = weekEvents.filter(evt => {
                const s = new Date(evt.startDate);
                const e = new Date(evt.endDate);
                return (e - s) / (1000 * 60 * 60) >= 20;
            });
            
            const timedEvents = weekEvents.filter(evt => {
                const s = new Date(evt.startDate);
                const e = new Date(evt.endDate);
                return (e - s) / (1000 * 60 * 60) < 20;
            });
            
            if (allDayEvents.length > 0) {
                const allDaySection = document.createElement('div');
                allDaySection.style.gridColumn = '1 / -1';
                allDaySection.className = 'all-day-events';
                
                const header = document.createElement('div');
                header.style.fontWeight = '700';
                header.style.fontSize = '12px';
                header.style.marginBottom = '8px';
                header.style.color = '#92400e';
                header.textContent = 'üìÖ Ï¢ÖÏùº/Ïû•Í∏∞ ÏùºÏ†ï';
                allDaySection.appendChild(header);
                
                allDayEvents.forEach(evt => {
                    const isAssigned = rentals.some(r => r.reason === evt.title && r.status === 'ÏÇ¨Ïö©Ï§ë');
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'all-day-event';
                    eventDiv.textContent = (isAssigned ? '‚úì ' : '') + evt.title + ' | ' + evt.interpretType + ' | ' + (evt.assignee || 'ÎØ∏ÏßÄÏ†ï');
                    eventDiv.onclick = function() {
                        console.log('Ï¢ÖÏùº Ïù¥Î≤§Ìä∏ ÌÅ¥Î¶≠:', evt.eventId);
                        openAssignModal(evt.eventId);
                    };
                    allDaySection.appendChild(eventDiv);
                });
                
                grid.appendChild(allDaySection);
            }
            
            const corner = document.createElement('div');
            corner.className = 'time-label';
            corner.textContent = 'ÏãúÍ∞Ñ';
            grid.appendChild(corner);
            
            const days = ['Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†', 'Ïùº'];
            const today = new Date().toDateString();
            
            for (let i = 0; i < 7; i++) {
                const d = new Date(ws);
                d.setDate(ws.getDate() + i);
                const h = document.createElement('div');
                h.className = 'day-header';
                if (d.toDateString() === today) h.classList.add('today');
                h.innerHTML = `${days[i]}<br>${d.getMonth()+1}/${d.getDate()}`;
                grid.appendChild(h);
            }
            
            for (let hour = 9; hour <= 18; hour++) {
                const tl = document.createElement('div');
                tl.className = 'time-label';
                tl.textContent = hour + ':00';
                grid.appendChild(tl);
                
                for (let i = 0; i < 7; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'time-slot';
                    slot.id = `slot-${i}-${hour}`;
                    slot.style.position = 'relative';
                    grid.appendChild(slot);
                }
            }
            
            timedEvents.forEach(evt => {
                const start = new Date(evt.startDate);
                const end = new Date(evt.endDate);
                const dayIndex = (start.getDay() + 6) % 7;
                const startHour = start.getHours();
                const startMin = start.getMinutes();
                
                if (startHour < 9 || startHour > 18) return;
                
                const targetSlot = document.getElementById(`slot-${dayIndex}-${startHour}`);
                if (!targetSlot) return;
                
                const duration = (end - start) / (1000 * 60 * 60);
                const height = Math.max(duration * 70, 40);
                const topOffset = (startMin / 60) * 70;
                
                const isAssigned = rentals.some(r => r.reason === evt.title && r.status === 'ÏÇ¨Ïö©Ï§ë');
                
                const block = document.createElement('div');
                block.className = 'event-block ' + evt.interpretType.replace(/ /g, '') + (isAssigned ? ' assigned' : '');
                block.style.height = height + 'px';
                block.style.top = topOffset + 'px';
                block.style.left = '2px';
                block.style.right = '2px';
                
                let deviceInfo = '';
                if (isAssigned) {
                    const rental = rentals.find(r => r.reason === evt.title && r.status === 'ÏÇ¨Ïö©Ï§ë');
                    if (rental) {
                        const devices = [];
                        if (rental.newTransmitter > 0) devices.push(`‚ú®ÏÜ°${rental.newTransmitter}`);
                        if (rental.newReceiver > 0) devices.push(`Ïàò${rental.newReceiver}`);
                        if (rental.oldTransmitter > 0) devices.push(`‚öôÔ∏èÏÜ°${rental.oldTransmitter}`);
                        if (rental.oldReceiver > 0) devices.push(`Ïàò${rental.oldReceiver}`);
                        deviceInfo = '<br>' + devices.join(' ');
                    }
                }
                
                block.innerHTML = evt.title + deviceInfo + (isAssigned ? '<div class="assigned-badge">‚úì</div>' : '');
                block.onclick = function(e) { 
                    e.stopPropagation();
                    openAssignModal(evt.eventId); 
                };
                
                targetSlot.appendChild(block);
            });
        }

        function openAssignModal(eventId) {
            const event = events.find(e => e.eventId === eventId);
            if (!event) return;
            
            selectedEvent = event;
            
            const assigned = rentals.find(r => r.reason === event.title && r.status === 'ÏÇ¨Ïö©Ï§ë');
            
            document.getElementById('assignModalTitle').textContent = event.title;
            document.getElementById('assignModalInfo').innerHTML = `
                <strong>üìÖ ÏùºÏ†ï:</strong> ${new Date(event.startDate).toLocaleString('ko-KR')} ~ ${new Date(event.endDate).toLocaleString('ko-KR')}<br>
                <strong>üé§ Ïú†Ìòï:</strong> ${event.interpretType}<br>
                <strong>üë§ Îã¥Îãπ:</strong> ${event.assignee || 'ÎØ∏ÏßÄÏ†ï'}
                ${assigned ? '<br><br><strong style="color: #10b981; font-size: 16px;">‚úÖ Ïù¥ÎØ∏ Í∏∞Í∏∞Í∞Ä Î∞∞Ï†ïÎêòÏñ¥ ÏûàÏäµÎãàÎã§</strong>' : ''}
            `;
            
            if (assigned) {
                document.getElementById('modalNewTx').value = assigned.newTransmitter || '0';
                document.getElementById('modalNewRx').value = assigned.newReceiver || '0';
                document.getElementById('modalOldTx').value = assigned.oldTransmitter || '0';
                document.getElementById('modalOldRx').value = assigned.oldReceiver || '0';
            } else {
                document.getElementById('modalNewTx').value = '0';
                document.getElementById('modalNewRx').value = '0';
                document.getElementById('modalOldTx').value = '0';
                document.getElementById('modalOldRx').value = '0';
            }
            
            document.getElementById('assignModal').classList.add('active');
        }

        function closeAssignModal() {
            document.getElementById('assignModal').classList.remove('active');
            selectedEvent = null;
        }

        async function saveAssignment() {
            if (!selectedEvent) return;
            
            const nTx = parseInt(document.getElementById('modalNewTx').value) || 0;
            const nRx = parseInt(document.getElementById('modalNewRx').value) || 0;
            const oTx = parseInt(document.getElementById('modalOldTx').value) || 0;
            const oRx = parseInt(document.getElementById('modalOldRx').value) || 0;

            if (nTx + nRx + oTx + oRx === 0) {
                alert('‚ùå ÏµúÏÜå 1Í∞ú Ïù¥ÏÉÅ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');
                return;
            }

            const params = new URLSearchParams({
                action: 'addRental',
                user: selectedEvent.assignee || 'ÎØ∏ÏßÄÏ†ï',
                startDate: selectedEvent.startDate,
                endDate: selectedEvent.endDate,
                reason: selectedEvent.title,
                newTransmitter: nTx,
                newReceiver: nRx,
                oldTransmitter: oTx,
                oldReceiver: oRx,
                type: selectedEvent.interpretType
            });

            try {
                await fetch(WEB_APP_URL + '?' + params.toString());
                alert('‚úÖ Í∏∞Í∏∞Í∞Ä Î∞∞Ï†ïÎêòÏóàÏäµÎãàÎã§!');
                await loadRentals();
                updateAll();
                closeAssignModal();
            } catch (error) {
                alert('‚ùå Î∞∞Ï†ï Ïò§Î•ò: ' + error);
            }
        }

        function updateList() {
            const list = document.getElementById('rentalList');
            if (rentals.length === 0) {
                list.innerHTML = '<div class="loading">Î∞òÏ∂ú Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</div>';
                return;
            }

            list.innerHTML = rentals.slice().reverse().map(r => `
                <div style="background: #f9fafb; border-radius: 12px; padding: 20px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <div style="font-weight: 700; font-size: 18px;">${r.user} - ${r.reason}</div>
                        <button onclick="deleteRental(${r.id})" style="background: #ef4444; color: white; padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ÏÇ≠Ï†ú</button>
                    </div>
                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 10px;">
                        üìÖ ${new Date(r.startDate).toLocaleString('ko-KR')} ~ ${new Date(r.endDate).toLocaleString('ko-KR')}
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 8px; font-size: 13px;">
                        ${r.newTransmitter > 0 ? `‚ú® Ïã†Ìòï ÏÜ°Ïã†Í∏∞: ${r.newTransmitter}ÎåÄ` : ''}
                        ${r.newReceiver > 0 ? ` / ÏàòÏã†Í∏∞: ${r.newReceiver}ÎåÄ` : ''}
                        ${r.oldTransmitter > 0 ? `<br>‚öôÔ∏è Íµ¨Ìòï ÏÜ°Ïã†Í∏∞: ${r.oldTransmitter}ÎåÄ` : ''}
                        ${r.oldReceiver > 0 ? ` / ÏàòÏã†Í∏∞: ${r.oldReceiver}ÎåÄ` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function deleteRental(id) {
            if (!confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            const p = new URLSearchParams({ action: 'deleteRental', id });
            try {
                await fetch(WEB_APP_URL + '?' + p.toString());
                alert('‚úÖ ÏÇ≠Ï†ú ÏôÑÎ£å');
                await loadRentals();
                updateAll();
            } catch (e) { alert('‚ùå Ïò§Î•ò: ' + e); }
        }

        function updateAll() {
            updateInvDisplay();
            updateTeamUpWeekly();
            updateList();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
