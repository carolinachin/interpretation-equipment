<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µì—­ê¸°ê¸° ê´€ë¦¬</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header h1 { color: #667eea; font-size: 2rem; }
        .header-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .sync-btn {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        .sync-btn:hover { background: #059669; }
        .sync-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .inventory-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .inventory-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #0ea5e9;
        }
        .inventory-title { font-size: 16px; font-weight: 700; color: #0c4a6e; margin-bottom: 15px; }
        .device-row {
            display: flex;
            justify-content: space-between;
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .device-count { font-size: 20px; font-weight: 700; color: #0ea5e9; }
        .device-count.low { color: #ef4444; }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(255,255,255,0.3);
            color: white;
            font-size: 14px;
        }
        .tab-btn.active { background: white; color: #667eea; }
        .content { display: none; }
        .content.active { display: block; }
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .card h2 { color: #1f2937; font-size: 1.5rem; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #374151; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .time-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .device-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .device-input-group {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
        }
        .device-input-group label { display: block; font-size: 14px; font-weight: 600; color: #6b7280; margin-bottom: 8px; }
        .device-input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
        }
        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }
        .alert-box {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #92400e;
        }
        .info-box {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #1e40af;
        }
        .week-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .week-nav button, .month-nav button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        .week-nav button:hover { background: #5568d3; }
        .weekly-grid {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 1px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }
        .time-label {
            background: #f9fafb;
            padding: 12px 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            border-right: 2px solid #e5e7eb;
        }
        .day-header {
            background: #f3f4f6;
            padding: 12px;
            text-align: center;
            font-weight: 700;
            font-size: 13px;
            color: #374151;
        }
        .day-header.today { background: #dbeafe; color: #1e40af; }
        .time-slot {
            background: white;
            padding: 8px;
            min-height: 70px;
            font-size: 11px;
            position: relative;
        }
        .time-slot.available { background: #f0fdf4; }
        .time-slot.low { background: #fef3c7; }
        .time-slot.critical { background: #fee2e2; }
        .slot-stock { font-weight: 600; margin-bottom: 2px; }
        .event-in-slot {
            background: #e0e7ff;
            border-left: 3px solid #6366f1;
            padding: 4px;
            margin-top: 4px;
            font-size: 10px;
            border-radius: 3px;
            color: #3730a3;
            font-weight: 600;
            cursor: pointer;
        }
        .event-in-slot:hover { background: #c7d2fe; }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .calendar-day {
            min-height: 100px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px;
            background: white;
        }
        .calendar-day.empty { border: none; background: transparent; }
        .calendar-header-day {
            background: #f3f4f6;
            padding: 10px;
            text-align: center;
            font-weight: 700;
            border-radius: 8px;
        }
        .day-number { font-weight: 700; font-size: 16px; margin-bottom: 5px; }
        .day-stock {
            font-size: 11px;
            padding: 3px 6px;
            border-radius: 4px;
            margin-bottom: 3px;
            font-weight: 600;
        }
        .day-stock.new { background: #dbeafe; color: #1e40af; }
        .day-stock.old { background: #fef3c7; color: #92400e; }
        .day-stock.low { background: #fecaca; color: #991b1b; }
        .rental-item {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        .rental-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .rental-title { font-weight: 700; font-size: 18px; color: #1f2937; }
        .rental-actions { display: flex; gap: 8px; }
        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-delete { background: #ef4444; color: white; }
        .btn-delete:hover { background: #dc2626; }
        .device-list {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
        }
        .loading { text-align: center; padding: 40px; color: #6b7280; }
        @media (max-width: 768px) {
            .form-row, .device-selector, .inventory-grid, .time-selector { grid-template-columns: 1fr; }
            .weekly-grid { grid-template-columns: 60px repeat(7, 1fr); font-size: 10px; }
            .header h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>ğŸ™ï¸ í†µì—­ê¸°ê¸° ê´€ë¦¬</h1>
                <div class="header-buttons">
                    <button class="sync-btn" onclick="manualRefresh()" id="refreshBtn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    <button class="sync-btn" onclick="syncTeamUp()" id="syncBtn">ğŸ“… TeamUp ë™ê¸°í™”</button>
                </div>
            </div>
            
            <div class="inventory-grid">
                <div class="inventory-card">
                    <div class="inventory-title">ğŸ†• ì‹ í˜• ëª¨ë¸ ì¬ê³ </div>
                    <div class="device-row">
                        <span>ì†¡ì‹ ê¸°</span>
                        <span class="device-count" id="newTxStock">-</span>
                    </div>
                    <div class="device-row">
                        <span>ìˆ˜ì‹ ê¸°</span>
                        <span class="device-count" id="newRxStock">-</span>
                    </div>
                </div>
                
                <div class="inventory-card">
                    <div class="inventory-title">ğŸ“» êµ¬í˜• ëª¨ë¸ ì¬ê³ </div>
                    <div class="device-row">
                        <span>ì†¡ì‹ ê¸°</span>
                        <span class="device-count" id="oldTxStock">-</span>
                    </div>
                    <div class="device-row">
                        <span>ìˆ˜ì‹ ê¸°</span>
                        <span class="device-count" id="oldRxStock">-</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('teamup')">TeamUp ì£¼ê°„</button>
            <button class="tab-btn" onclick="showTab('weekly')">ì¬ê³  ì£¼ê°„ë·°</button>
            <button class="tab-btn" onclick="showTab('monthly')">ì¬ê³  ì›”ê°„ë·°</button>
            <button class="tab-btn" onclick="showTab('rental')">ìˆ˜ë™ì‹ ì²­</button>
            <button class="tab-btn" onclick="showTab('list')">ëª©ë¡</button>
        </div>

        <div id="teamup" class="content active">
            <div class="card" style="padding: 0; overflow: hidden;">
                <div style="padding: 20px; border-bottom: 2px solid #e5e7eb;">
                    <div class="week-nav">
                        <button onclick="changeTeamUpWeek(-1)">â—€ ì´ì „ ì£¼</button>
                        <h2 id="teamupWeekTitle" style="margin: 0;">TeamUp ì£¼ê°„ ì¼ì •</h2>
                        <button onclick="changeTeamUpWeek(1)">ë‹¤ìŒ ì£¼ â–¶</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <div class="weekly-grid" id="teamupWeeklyGrid"></div>
                </div>
            </div>
        </div>

        <div id="weekly" class="content">
            <div class="card" style="padding: 0; overflow: hidden;">
                <div style="padding: 20px; border-bottom: 2px solid #e5e7eb;">
                    <div class="week-nav">
                        <button onclick="changeStockWeek(-1)">â—€ ì´ì „ ì£¼</button>
                        <h2 id="stockWeekTitle" style="margin: 0;">ì£¼ê°„ ì¬ê³  í˜„í™©</h2>
                        <button onclick="changeStockWeek(1)">ë‹¤ìŒ ì£¼ â–¶</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <div class="weekly-grid" id="stockWeeklyGrid"></div>
                </div>
            </div>
        </div>

        <div id="monthly" class="content">
            <div class="card">
                <div class="week-nav">
                    <button onclick="changeMonth(-1)">â—€ ì´ì „ ë‹¬</button>
                    <h2 id="monthTitle" style="margin: 0;">ì›”ê°„ ì¬ê³  í˜„í™©</h2>
                    <button onclick="changeMonth(1)">ë‹¤ìŒ ë‹¬ â–¶</button>
                </div>
                <div class="calendar" id="calendarGrid"></div>
            </div>
        </div>

        <div id="rental" class="content">
            <div class="card">
                <h2>ì§ì ‘ ë°˜ì¶œ ì‹ ì²­</h2>
                <div class="alert-box">ğŸ’¡ TeamUpì— ì—†ëŠ” ì¼ì •ì´ê±°ë‚˜ ê¸´ê¸‰í•œ ê²½ìš° ì§ì ‘ ì‹ ì²­í•˜ì„¸ìš”.</div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ì‚¬ìš©ì *</label>
                        <select id="userName">
                            <option value="">ì„ íƒ</option>
                            <option value="ê·œì—°">ê·œì—°</option>
                            <option value="ë‹¤í˜„">ë‹¤í˜„</option>
                            <option value="ì†Œë‹´">ì†Œë‹´</option>
                            <option value="ì„±í›ˆ">ì„±í›ˆ</option>
                            <option value="ìŠ¹ì—°">ìŠ¹ì—°</option>
                            <option value="ìŠ¹í—Œ">ìŠ¹í—Œ</option>
                            <option value="ì•„ì˜">ì•„ì˜</option>
                            <option value="ì—ë¦¬ì¹´">ì—ë¦¬ì¹´</option>
                            <option value="ì˜ì•„">ì˜ì•„</option>
                            <option value="ìš°ë¹ˆ">ìš°ë¹ˆ</option>
                            <option value="ì€í˜œ">ì€í˜œ</option>
                            <option value="ì£¼í™”">ì£¼í™”</option>
                            <option value="í•˜ê²½">í•˜ê²½</option>
                            <option value="í˜œì›">í˜œì›</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ìœ í˜• *</label>
                        <select id="rentalType">
                            <option value="í˜„ì¥í†µì—­">í˜„ì¥í†µì—­</option>
                            <option value="ì™¸ê·¼">ì™¸ê·¼</option>
                            <option value="êµ­ë‚´ ì¶œì¥">êµ­ë‚´ ì¶œì¥</option>
                            <option value="í•´ì™¸ ì¶œì¥">í•´ì™¸ ì¶œì¥</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ì‹œì‘ì¼ *</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="form-group">
                        <label>ì¢…ë£Œì¼ *</label>
                        <input type="date" id="endDate">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ì‹œì‘ ì‹œê°„ *</label>
                        <div class="time-selector">
                            <select id="startAmPm"><option value="AM">ì˜¤ì „</option><option value="PM">ì˜¤í›„</option></select>
                            <select id="startHour">
                                <option value="9" selected>9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                            <select id="startMinute"><option value="00">00</option><option value="30">30</option></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ì¢…ë£Œ ì‹œê°„ *</label>
                        <div class="time-selector">
                            <select id="endAmPm"><option value="AM">ì˜¤ì „</option><option value="PM" selected>ì˜¤í›„</option></select>
                            <select id="endHour">
                                <option value="6" selected>6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                            </select>
                            <select id="endMinute"><option value="00">00</option><option value="30">30</option></select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>ì‚¬ìœ  *</label>
                    <textarea id="reason" rows="2" placeholder="ì›Œí¬ìƒµ, ì¶œì¥ ë“±"></textarea>
                </div>

                <h3 style="margin: 20px 0 15px 0; color: #374151;">ì‚¬ìš© ê¸°ê¸°</h3>
                <div class="device-selector">
                    <div class="device-input-group">
                        <label>ğŸ†• ì‹ í˜• ì†¡ì‹ ê¸°</label>
                        <input type="number" id="newTx" min="0" value="0">
                    </div>
                    <div class="device-input-group">
                        <label>ğŸ†• ì‹ í˜• ìˆ˜ì‹ ê¸°</label>
                        <input type="number" id="newRx" min="0" value="0">
                    </div>
                    <div class="device-input-group">
                        <label>ğŸ“» êµ¬í˜• ì†¡ì‹ ê¸°</label>
                        <input type="number" id="oldTx" min="0" value="0">
                    </div>
                    <div class="device-input-group">
                        <label>ğŸ“» êµ¬í˜• ìˆ˜ì‹ ê¸°</label>
                        <input type="number" id="oldRx" min="0" value="0">
                    </div>
                </div>

                <button class="submit-btn" onclick="submitRental()">ì‹ ì²­í•˜ê¸°</button>
            </div>
        </div>

        <div id="list" class="content">
            <div class="card">
                <h2>ì „ì²´ ë°˜ì¶œ ëª©ë¡</h2>
                <div id="rentalList"></div>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbygxNiQ5NOpl83EP0xrE8Wz2RFQPfYZns-KE3xUolt5ZpBflSrtYWJJcU2Ii54CH1mCRQ/exec';
        
        let inv = { new_model: { transmitter: 4, receiver: 28 }, old_model: { transmitter: 5, receiver: 31 } };
        let rentals = [];
        let events = [];
        let teamupWeek = new Date();
        let stockWeek = new Date();
        let currentMonth = new Date();

        async function init() {
            try {
                const test = await fetch(WEB_APP_URL + '?action=getInventory', { method: 'GET', redirect: 'follow' });
                if (!test.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
                await loadInventory();
                await loadRentals();
                await loadTeamUpEvents();
                updateAll();
                console.log('âœ… ì„œë²„ ì—°ê²° ì„±ê³µ');
            } catch (error) {
                console.warn('âš ï¸ ë”ë¯¸ ë°ì´í„° ëª¨ë“œ');
                initDummy();
            }
        }

        function initDummy() {
            events = [
                { eventId: '1', title: 'KBR ì›Œí¬ìƒµ', startDate: '2026-01-20T09:00:00', endDate: '2026-01-20T17:00:00', interpretType: 'í˜„ì¥í†µì—­', assignee: 'ë‹¤í˜„' },
                { eventId: '2', title: 'G-Star', startDate: '2026-01-22T10:00:00', endDate: '2026-01-22T12:00:00', interpretType: 'í•´ì™¸ ì¶œì¥', assignee: 'ìŠ¹ì—°' },
                { eventId: '3', title: 'ë¸ë¼ì›¨ì–´ ë¯¸íŒ…', startDate: '2026-01-23T14:00:00', endDate: '2026-01-23T16:00:00', interpretType: 'í˜„ì¥í†µì—­', assignee: 'ì†Œë‹´' }
            ];
            updateAll();
        }

        async function loadInventory() {
            try {
                const r = await fetch(WEB_APP_URL + '?action=getInventory', { method: 'GET', redirect: 'follow' });
                const d = await r.json();
                if (d.success) inv = d.inventory;
                updateInvDisplay();
            } catch (e) { console.error('ì¬ê³  ì˜¤ë¥˜:', e); }
        }

        async function loadRentals() {
            try {
                const r = await fetch(WEB_APP_URL + '?action=getRentals', { method: 'GET', redirect: 'follow' });
                const d = await r.json();
                if (d.success) rentals = d.rentals;
            } catch (e) { console.error('ë°˜ì¶œ ì˜¤ë¥˜:', e); }
        }

        async function loadTeamUpEvents() {
            try {
                const r = await fetch(WEB_APP_URL + '?action=getTeamUpEvents', { method: 'GET', redirect: 'follow' });
                const d = await r.json();
                if (d.success) events = d.events;
            } catch (e) { console.error('TeamUp ì˜¤ë¥˜:', e); }
        }

        async function manualRefresh() {
            const btn = document.getElementById('refreshBtn');
            btn.textContent = 'â³ ë¡œë”©...';
            btn.disabled = true;
            await loadInventory();
            await loadRentals();
            await loadTeamUpEvents();
            updateAll();
            btn.textContent = 'ğŸ”„ ìƒˆë¡œê³ ì¹¨';
            btn.disabled = false;
        }

        async function syncTeamUp() {
            const btn = document.getElementById('syncBtn');
            btn.textContent = 'â³ ë™ê¸°í™”...';
            btn.disabled = true;
            try {
                const r = await fetch(WEB_APP_URL + '?action=syncTeamUp', { method: 'GET', redirect: 'follow' });
                const d = await r.json();
                if (d.success) {
                    alert(`âœ… ì™„ë£Œ!\nì „ì²´: ${d.total}ê°œ\nì €ì¥: ${d.count}ê°œ`);
                    await loadTeamUpEvents();
                    updateAll();
                } else {
                    alert('âŒ ì‹¤íŒ¨: ' + d.error);
                }
            } catch (e) { alert('âŒ ì˜¤ë¥˜: ' + e); }
            btn.textContent = 'ğŸ“… TeamUp ë™ê¸°í™”';
            btn.disabled = false;
        }

        function updateInvDisplay() {
            document.getElementById('newTxStock').textContent = inv.new_model.transmitter;
            document.getElementById('newRxStock').textContent = inv.new_model.receiver;
            document.getElementById('oldTxStock').textContent = inv.old_model.transmitter;
            document.getElementById('oldRxStock').textContent = inv.old_model.receiver;
        }

        function showTab(tab) {
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
            
            if (tab === 'teamup') updateTeamUpWeekly();
            else if (tab === 'weekly') updateStockWeekly();
            else if (tab === 'monthly') updateMonthly();
            else if (tab === 'list') updateList();
        }

        function changeTeamUpWeek(d) {
            if (d === 0) teamupWeek = new Date();
            else teamupWeek.setDate(teamupWeek.getDate() + (d * 7));
            updateTeamUpWeekly();
        }

        function changeStockWeek(d) {
            if (d === 0) stockWeek = new Date();
            else stockWeek.setDate(stockWeek.getDate() + (d * 7));
            updateStockWeekly();
        }

        function changeMonth(d) {
            currentMonth.setMonth(currentMonth.getMonth() + d);
            updateMonthly();
        }

        function updateTeamUpWeekly() {
            const grid = document.getElementById('teamupWeeklyGrid');
            grid.innerHTML = '';
            
            const ws = new Date(teamupWeek);
            ws.setDate(teamupWeek.getDate() - teamupWeek.getDay() + 1);
            const we = new Date(ws);
            we.setDate(ws.getDate() + 6);
            
            document.getElementById('teamupWeekTitle').textContent = 
                `${ws.getMonth()+1}/${ws.getDate()} ~ ${we.getMonth()+1}/${we.getDate()}`;
            
            const corner = document.createElement('div');
            corner.className = 'time-label';
            corner.textContent = 'ì‹œê°„';
            grid.appendChild(corner);
            
            const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
            const today = new Date().toDateString();
            
            for (let i = 0; i < 7; i++) {
                const d = new Date(ws);
                d.setDate(ws.getDate() + i);
                const h = document.createElement('div');
                h.className = 'day-header';
                if (d.toDateString() === today) h.classList.add('today');
                h.innerHTML = `${days[i]}<br>${d.getMonth()+1}/${d.getDate()}`;
                grid.appendChild(h);
            }
            
            for (let hour = 9; hour <= 18; hour++) {
                const tl = document.createElement('div');
                tl.className = 'time-label';
                tl.textContent = hour + ':00';
                grid.appendChild(tl);
                
                for (let i = 0; i < 7; i++) {
                    const d = new Date(ws);
                    d.setDate(ws.getDate() + i);
                    d.setHours(hour, 0, 0, 0);
                    
                    const slot = document.createElement('div');
                    slot.className = 'time-slot';
                    
                    const eventsInSlot = events.filter(evt => {
                        const start = new Date(evt.startDate);
                        const end = new Date(evt.endDate);
                        return d >= start && d <= end;
                    });
                    
                    if (eventsInSlot.length > 0) {
                        slot.style.background = '#fef3c7';
                        eventsInSlot.forEach(evt => {
                            const div = document.createElement('div');
                            div.className = 'event-in-slot';
                            div.textContent = evt.title.length > 15 ? evt.title.substring(0, 15) + '...' : evt.title;
                            div.title = evt.title + '\n' + evt.interpretType + '\n' + (evt.assignee || '');
                            slot.appendChild(div);
                        });
                    }
                    
                    grid.appendChild(slot);
                }
            }
        }

        function updateStockWeekly() {
            const grid = document.getElementById('stockWeeklyGrid');
            grid.innerHTML = '';
            
            const ws = new Date(stockWeek);
            ws.setDate(stockWeek.getDate() - stockWeek.getDay() + 1);
            const we = new Date(ws);
            we.setDate(ws.getDate() + 6);
            
            document.getElementById('stockWeekTitle').textContent = 
                `${ws.getMonth()+1}/${ws.getDate()} ~ ${we.getMonth()+1}/${we.getDate()}`;
            
            const corner = document.createElement('div');
            corner.className = 'time-label';
            corner.textContent = 'ì‹œê°„';
            grid.appendChild(corner);
            
            const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
            const today = new Date().toDateString();
            
            for (let i = 0; i < 7; i++) {
                const d = new Date(ws);
                d.setDate(ws.getDate() + i);
                const h = document.createElement('div');
                h.className = 'day-header';
                if (d.toDateString() === today) h.classList.add('today');
                h.innerHTML = `${days[i]}<br>${d.getMonth()+1}/${d.getDate()}`;
                grid.appendChild(h);
            }
            
            for (let hour = 9; hour <= 18; hour++) {
                const tl = document.createElement('div');
                tl.className = 'time-label';
                tl.textContent = hour + ':00';
                grid.appendChild(tl);
                
                for (let i = 0; i < 7; i++) {
                    const d = new Date(ws);
                    d.setDate(ws.getDate() + i);
                    d.setHours(hour, 0, 0, 0);
                    
                    const slot = document.createElement('div');
                    slot.className = 'time-slot';
                    
                    const used = calcUsedAtTime(d);
                    const av = {
                        newTx: inv.new_model.transmitter - used.newTx,
                        newRx: inv.new_model.receiver - used.newRx,
                        oldTx: inv.old_model.transmitter - used.oldTx,
                        oldRx: inv.old_model.receiver - used.oldRx
                    };
                    
                    if (av.newTx <= 1 || av.newRx <= 5 || av.oldTx <= 1 || av.oldRx <= 5) {
                        slot.classList.add('critical');
                    } else if (av.newTx <= 2 || av.newRx <= 10 || av.oldTx <= 2 || av.oldRx <= 10) {
                        slot.classList.add('low');
                    } else {
                        slot.classList.add('available');
                    }
                    
                    slot.innerHTML = `
                        <div class="slot-stock">ğŸ†• ì†¡${av.newTx} ìˆ˜${av.newRx}</div>
                        <div class="slot-stock">ğŸ“» ì†¡${av.oldTx} ìˆ˜${av.oldRx}</div>
                    `;
                    
                    grid.appendChild(slot);
                }
            }
        }

        function calcUsedAtTime(dt) {
            const used = { newTx: 0, newRx: 0, oldTx: 0, oldRx: 0 };
            rentals.forEach(r => {
                if (r.status !== 'ì‚¬ìš©ì¤‘') return;
                const s = new Date(r.startDate);
                const e = new Date(r.endDate);
                if (dt >= s && dt <= e) {
                    used.newTx += parseInt(r.newTransmitter) || 0;
                    used.newRx += parseInt(r.newReceiver) || 0;
                    used.oldTx += parseInt(r.oldTransmitter) || 0;
                    used.oldRx += parseInt(r.oldReceiver) || 0;
                }
            });
            return used;
        }

        function updateMonthly() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            const y = currentMonth.getFullYear();
            const m = currentMonth.getMonth();
            document.getElementById('monthTitle').textContent = `${y}ë…„ ${m+1}ì›” ì¬ê³ `;

            ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].forEach(day => {
                const h = document.createElement('div');
                h.className = 'calendar-header-day';
                h.textContent = day;
                grid.appendChild(h);
            });

            const first = new Date(y, m, 1);
            const days = new Date(y, m + 1, 0).getDate();
            const start = first.getDay();

            for (let i = 0; i < start; i++) {
                const e = document.createElement('div');
                e.className = 'calendar-day empty';
                grid.appendChild(e);
            }

            for (let day = 1; day <= days; day++) {
                const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const el = document.createElement('div');
                el.className = 'calendar-day';
                
                const used = calcUsedOnDate(ds);
                const av = {
                    newTx: inv.new_model.transmitter - used.newTx,
                    newRx: inv.new_model.receiver - used.newRx,
                    oldTx: inv.old_model.transmitter - used.oldTx,
                    oldRx: inv.old_model.receiver - used.oldRx
                };

                el.innerHTML = `
                    <div class="day-number">${day}</div>
                    <div class="day-stock new ${av.newTx <= 1 || av.newRx <= 5 ? 'low' : ''}">
                        ğŸ†• ì†¡${av.newTx} ìˆ˜${av.newRx}
                    </div>
                    <div class="day-stock old ${av.oldTx <= 1 || av.oldRx <= 5 ? 'low' : ''}">
                        ğŸ“» ì†¡${av.oldTx} ìˆ˜${av.oldRx}
                    </div>
                `;
                grid.appendChild(el);
            }
        }

        function calcUsedOnDate(ds) {
            const used = { newTx: 0, newRx: 0, oldTx: 0, oldRx: 0 };
            rentals.forEach(r => {
                if (r.status !== 'ì‚¬ìš©ì¤‘') return;
                const s = new Date(r.startDate).toISOString().split('T')[0];
                const e = new Date(r.endDate).toISOString().split('T')[0];
                if (ds >= s && ds <= e) {
                    used.newTx += parseInt(r.newTransmitter) || 0;
                    used.newRx += parseInt(r.newReceiver) || 0;
                    used.oldTx += parseInt(r.oldTransmitter) || 0;
                    used.oldRx += parseInt(r.oldReceiver) || 0;
                }
            });
            return used;
        }

        function getDateTime(date, ampm, hour, min) {
            let h = parseInt(hour);
            if (ampm === 'PM' && h !== 12) h += 12;
            if (ampm === 'AM' && h === 12) h = 0;
            const dt = new Date(date);
            dt.setHours(h, parseInt(min), 0, 0);
            return dt.toISOString();
        }

        async function submitRental() {
            const user = document.getElementById('userName').value;
            const type = document.getElementById('rentalType').value;
            const sd = document.getElementById('startDate').value;
            const ed = document.getElementById('endDate').value;
            const sap = document.getElementById('startAmPm').value;
            const sh = document.getElementById('startHour').value;
            const sm = document.getElementById('startMinute').value;
            const eap = document.getElementById('endAmPm').value;
            const eh = document.getElementById('endHour').value;
            const em = document.getElementById('endMinute').value;
            const reason = document.getElementById('reason').value.trim();
            
            const nTx = parseInt(document.getElementById('newTx').value) || 0;
            const nRx = parseInt(document.getElementById('newRx').value) || 0;
            const oTx = parseInt(document.getElementById('oldTx').value) || 0;
            const oRx = parseInt(document.getElementById('oldRx').value) || 0;

            if (!user || !sd || !ed || !reason) {
                alert('âŒ í•„ìˆ˜ í•­ëª© ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            if (nTx + nRx + oTx + oRx === 0) {
                alert('âŒ ìµœì†Œ 1ê°œ ì„ íƒí•˜ì„¸ìš”');
                return;
            }

            const fsd = getDateTime(sd, sap, sh, sm);
            const fed = getDateTime(ed, eap, eh, em);

            const p = new URLSearchParams({
                action: 'addRental', user, startDate: fsd, endDate: fed, reason,
                newTransmitter: nTx, newReceiver: nRx, oldTransmitter: oTx, oldReceiver: oRx, type
            });

            try {
                await fetch(WEB_APP_URL + '?' + p.toString());
                alert('âœ… ì‹ ì²­ ì™„ë£Œ!');
                document.getElementById('userName').value = '';
                document.getElementById('reason').value = '';
                document.getElementById('newTx').value = '0';
                document.getElementById('newRx').value = '0';
                document.getElementById('oldTx').value = '0';
                document.getElementById('oldRx').value = '0';
                await loadRentals();
                updateAll();
            } catch (e) { alert('âŒ ì˜¤ë¥˜: ' + e); }
        }

        async function deleteRental(id) {
            if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const p = new URLSearchParams({ action: 'deleteRental', id });
            try {
                await fetch(WEB_APP_URL + '?' + p.toString());
                alert('âœ… ì‚­ì œ ì™„ë£Œ');
                await loadRentals();
                updateList();
            } catch (e) { alert('âŒ ì˜¤ë¥˜: ' + e); }
        }

        function updateList() {
            const list = document.getElementById('rentalList');
            if (rentals.length === 0) {
                list.innerHTML = '<div class="loading">ë°˜ì¶œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            list.innerHTML = rentals.slice().reverse().map(r => `
                <div class="rental-item">
                    <div class="rental-header">
                        <div class="rental-title">${r.user} - ${r.reason}</div>
                        <div class="rental-actions">
                            <button class="btn-small btn-delete" onclick="deleteRental(${r.id})">ì‚­ì œ</button>
                        </div>
                    </div>
                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 10px;">
                        ğŸ“… ${new Date(r.startDate).toLocaleString('ko-KR')} ~ ${new Date(r.endDate).toLocaleString('ko-KR')}
                    </div>
                    <div class="device-list">
                        ${r.newTransmitter > 0 ? `ğŸ†• ì‹ í˜• ì†¡ì‹ ê¸°: ${r.newTransmitter}ëŒ€` : ''}
                        ${r.newReceiver > 0 ? ` / ìˆ˜ì‹ ê¸°: ${r.newReceiver}ëŒ€` : ''}
                        ${r.oldTransmitter > 0 ? `<br>ğŸ“» êµ¬í˜• ì†¡ì‹ ê¸°: ${r.oldTransmitter}ëŒ€` : ''}
                        ${r.oldReceiver > 0 ? ` / ìˆ˜ì‹ ê¸°: ${r.oldReceiver}ëŒ€` : ''}
                    </div>
                </div>
            `).join('');
        }

        function updateAll() {
            updateInvDisplay();
            updateTeamUpWeekly();
            updateStockWeekly();
            updateMonthly();
            updateList();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            init();
        });
    </script>
</body>
</html>
